{
  "facts": [
    {
      "id": "tronc_config_2025-06-28",
      "data": {
        "entity_type": "tronc_config",
        "total_gratuities": 500.0,
        "deduction_percentage": 0.05
      }
    },
    {
      "id": "role_waiter",
      "data": {
        "entity_type": "role_weight",
        "role": "waiter",
        "weight": 1.0
      }
    },
    {
      "id": "role_bartender",
      "data": {
        "entity_type": "role_weight",
        "role": "bartender",
        "weight": 1.2
      }
    },
    {
      "id": "shift_A",
      "data": {
        "entity_type": "employee_shift",
        "employee_id": "emp_A",
        "hours_worked": 8.0,
        "role": "waiter"
      }
    },
    {
      "id": "shift_B",
      "data": {
        "entity_type": "employee_shift",
        "employee_id": "emp_B",
        "hours_worked": 6.0,
        "role": "waiter"
      }
    },
    {
      "id": "shift_C",
      "data": {
        "entity_type": "employee_shift",
        "employee_id": "emp_C",
        "hours_worked": 10.0,
        "role": "bartender"
      }
    }
  ],
  "rules": [
    {
      "id": "calculate-adjusted-tronc-pot",
      "priority": 300,
      "conditions": [
        {
          "field": "entity_type",
          "operator": "equal",
          "value": "tronc_config"
        }
      ],
      "actions": [
        {
          "type": "call_calculator",
          "calculator_name": "deduct_percentage",
          "input_mapping": {
            "total_amount": "total_gratuities",
            "percentage": "deduction_percentage"
          },
          "output_field": "adjusted_tronc_amount"
        },
        {
          "type": "create_fact",
          "fact_id": "tronc_pot",
          "fact_data": {
            "entity_type": "tronc_pot",
            "amount": "{{adjusted_tronc_amount}}"
          }
        }
      ]
    },
    {
      "id": "calculate-total-weighted-hours",
      "priority": 200,
      "conditions": [
        {
          "field": "entity_type",
          "operator": "equal",
          "value": "tronc_config"
        }
      ],
      "actions": [
        {
          "type": "call_calculator",
          "calculator_name": "weighted_sum_aggregator",
          "input_mapping": {
            "items": {
              "source_type": "aggregate_weighted_list",
              "filter": "entity_type == 'employee_shift'",
              "value_field": "hours_worked",
              "weight_spec": {
                "source_field": "role",
                "lookup_fact_type": "role_weight",
                "lookup_key_field": "role",
                "lookup_value_field": "weight"
              }
            }
          },
          "output_field": "total_weighted_hours"
        },
        {
          "type": "create_fact",
          "fact_id": "total_weighted_hours_fact",
          "fact_data": {
            "entity_type": "total_weighted_hours",
            "value": "{{total_weighted_hours}}"
          }
        }
      ]
    },
    {
      "id": "calculate-individual-allocations",
      "priority": 100,
      "conditions": [
        {
          "field": "entity_type",
          "operator": "equal",
          "value": "employee_shift"
        }
      ],
      "actions": [
        {
          "type": "call_calculator",
          "calculator_name": "multiply",
          "input_mapping": {
            "value1": "hours_worked",
            "value2": {
              "source_type": "fact_lookup",
              "filter": "entity_type == 'role_weight' && role == current_fact.role",
              "field": "weight"
            }
          },
          "output_field": "individual_weighted_hours"
        },
        {
          "type": "call_calculator",
          "calculator_name": "proportional_allocator",
          "input_mapping": {
            "total_amount": {
              "source_type": "fact_lookup",
              "fact_id": "tronc_pot",
              "field": "amount"
            },
            "individual_value": "{{individual_weighted_hours}}",
            "total_value": {
              "source_type": "fact_lookup",
              "fact_id": "total_weighted_hours_fact",
              "field": "value"
            }
          },
          "output_field": "allocation_amount"
        },
        {
          "type": "create_fact",
          "fact_id": "allocation_{{current_fact.employee_id}}",
          "fact_data": {
            "entity_type": "employee_allocation",
            "employee_id": "{{current_fact.employee_id}}",
            "allocation_amount": "{{allocation_amount}}"
          }
        }
      ]
    }
  ]
}